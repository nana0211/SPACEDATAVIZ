<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Columns to Download</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        #columns {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
        }
        .column-group {
            margin-bottom: 15px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        #download-link {
            margin-top: 20px;
        }
        #download-link a {
            background-color: #2ecc71;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 3px;
        }
        #download-link a:hover {
            background-color: #27ae60;
        }
        #loading, #form-loading {
            text-align: center;
            margin-top: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
        p.description {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Select Columns for Download</h1>

    <div id="loading">
        <div class="spinner"></div>
        <p>Loading columns, please wait...</p>
    </div>

    <div id="error-message" class="error-message hidden"></div>

    <form id="convert-form" class="hidden">
        <div id="columns">
            <h2>Select Columns</h2>
            <div id="column-list"></div>
        </div>

        <button type="submit">Convert and Download</button>
    </form>

    <div id="form-loading" class="hidden">
        <div class="spinner"></div>
        <p>Processing, please wait...</p>
    </div>

    <div id="download-link" style="display: none;"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadingElement = document.getElementById('loading');
        const errorMessageElement = document.getElementById('error-message');
        const convertForm = document.getElementById('convert-form');
        const formLoadingElement = document.getElementById('form-loading');
        const columnList = document.getElementById('column-list');
        let columnGroups;
        let outputOption = new URLSearchParams(window.location.search).get('output-option');

        const groupDescriptions = {
            'Player': 'This group includes player-related info: player id, age, gender, education level etc...',
            'Training': 'This group includes several time measures during the Training session. i.e. Rotation time is how long user rotated during training',
            'PI (for each trial)': 'Path Integration data for each trial, which includes PI time, PI distance, PI final angle, Corrected PI angle, and PI distance ratio',
            'Pointing error': 'Pointing_Error_Average is the mean pointing judgement error of each pointing task. Error_all; Pointing_Error_Average_all is the average of Pointing_Error_Averages from all trials.',
            'Map': 'Mapping Time is the total time in mapping task. R2 : degree of association (r2) of two planar configurations (i.e., the real map of the planet and the map created by the player) of related coordinate data. Estimated Coordinates are the coordinates (X, Y) of each Landmarks in the mapping task',
            'Memory': 'Memory Time is the total time in memory task. Memory correct is the Pairing accuracy percentage',
            'Perspective taking': 'Perspective taking time is the total time',
            'Overall Measures': 'Overall measures related to the entire experiment which includes start time and end time and total time of the play'
        };

        function showError(message) {
            loadingElement.classList.add('hidden');
            errorMessageElement.textContent = message;
            errorMessageElement.classList.remove('hidden');
        }

        function fetchColumns(outputOption) {
            fetch('/get_columns', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ output_option: outputOption })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                columnGroups = data;
                updateColumnSelection();

                loadingElement.classList.add('hidden');
                convertForm.classList.remove('hidden');
            })
            .catch(error => {
                showError(`An error occurred while fetching columns: ${error.message}`);
            });
        }

        function updateColumnSelection() {
            columnList.innerHTML = '';
            const columns = columnGroups;

            const orderedGroups = [
                'Player',
                'Training',
                'PI (for each trial)',
                'Pointing error',
                'Map',
                'Memory',
                'Perspective taking',
                'Overall Measures'
            ];

            orderedGroups.forEach(group => {
            if (columns[group]) {
                const groupColumns = columns[group];
                const groupDiv = document.createElement('div');
                groupDiv.className = 'column-group';

                groupDiv.innerHTML = `<h3>${group}</h3><p class="description">${groupDescriptions[group] || ''}</p>`;

                if (group === 'PI (for each trial)' || group === 'Perspective taking') {
                    // Special handling for PI trials to ensure correct order
                    const sortedKeys = Object.keys(groupColumns).sort((a, b) => {
                        if (a === 'PI_averages') return -1;
                        if (b === 'PI_averages') return 1;
                        const aNum = parseInt(a.split('_').pop());
                        const bNum = parseInt(b.split('_').pop());
                        return aNum - bNum;
                    });

                    sortedKeys.forEach(key => {
                        processColumns({[key]: groupColumns[key]}, groupDiv, 0, group);
                    });
                } else {
                    processColumns(groupColumns, groupDiv, 0, group);
                }

                columnList.appendChild(groupDiv);
        }
    });
}

        function processColumns(columns, parentDiv, depth = 0, path = '') {
            if (Array.isArray(columns)) {
                columns.forEach(column => {
                    const fullPath = path ? `${path}.${column}` : column;
                    parentDiv.innerHTML += `
                        <div style="margin-left: ${depth * 20}px;">
                            <input type="checkbox" id="${fullPath}" name="columns" value="${fullPath}" checked>
                            <label for="${fullPath}">${column}</label>
                        </div>
                    `;
                });
            } else if (typeof columns === 'object' && columns !== null) {
                for (const [subgroup, subcolumns] of Object.entries(columns)) {
                    const newPath = path ? `${path}.${subgroup}` : subgroup;

                    if (path === 'PI (for each trial)' && subgroup === 'PI_averages') {
                        const subgroupDiv = document.createElement('div');
                        subgroupDiv.style.marginLeft = `${depth * 20}px`;
                        subgroupDiv.innerHTML = `<h${Math.min(depth + 4, 6)}>${subgroup}</h${Math.min(depth + 4, 6)}>`;
                        processColumns(subcolumns, subgroupDiv, depth + 1, newPath);
                        parentDiv.appendChild(subgroupDiv);
                    } else if (path === 'Pointing error') {
                        if (subgroup.startsWith('Pointing_trial_')) {
                            const subgroupDiv = document.createElement('div');
                            subgroupDiv.style.marginLeft = `${depth * 20}px`;
                            // Changes start
                            subgroupDiv.innerHTML = `
                                <input type="checkbox" id="${newPath}" name="columns" value="${newPath}" checked>
                                <label for="${newPath}">${subgroup}</label>
                            `;
                            parentDiv.appendChild(subgroupDiv);
                            // Changes end
                            processColumns(subcolumns, subgroupDiv, depth + 1, newPath);
                        } else {
                            const subgroupDiv = document.createElement('div');
                            subgroupDiv.style.marginLeft = `${depth * 20}px`;
                            subgroupDiv.innerHTML = `<h${Math.min(depth + 4, 6)}>${subgroup}</h${Math.min(depth + 4, 6)}>`;
                            processColumns(subcolumns, subgroupDiv, depth + 1, newPath);
                            parentDiv.appendChild(subgroupDiv);
                        }
                    } else {
                        parentDiv.innerHTML += `
                            <div style="margin-left: ${depth * 20}px;">
                                <input type="checkbox" id="${newPath}" name="columns" value="${newPath}" checked>
                                <label for="${newPath}">${subgroup}</label>
                            </div>
                        `;
                    }
                }
            }
        }

        fetchColumns(outputOption);

        // Handle form submission
        document.getElementById('convert-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            formLoadingElement.classList.remove('hidden');
            formData.append('output_option', outputOption);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                formLoadingElement.classList.add('hidden');
                if (data.error) {
                    alert(data.error);
                } else if (data.download_link) {
                    const downloadLink = document.getElementById('download-link');
                    downloadLink.innerHTML = `<a href="/download/${data.download_link}" download>Download CSV</a>`;
                    downloadLink.style.display = 'block';
                }
            })
            .catch(error => {
                formLoadingElement.classList.add('hidden');
                console.error('Error:', error);
                alert('An error occurred while processing the file. Please try again.');
            });
        });
    });
    </script>
</body>
</html>